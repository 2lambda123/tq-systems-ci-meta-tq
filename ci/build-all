#!/bin/bash
# build all machines in a layer with a given config

readonly SCRIPTNAME="${0}"

usage()
{
	echo -e "\nUsage: ${SCRIPTNAME} <build-dir> <template> [mirror] \n \
	<build-dir>: specifies the build directory location (required) \n \
	<template>: template bblayers.conf to use \n \
	[mirror]: if given, download only and provide mirror tarballs \n
	[ci]: if given, use only mirror tarballs to build"
}

main () {
	# this disables network check
	export CONNECTIVITY_CHECK_URIS=" "

	local BUILD_DIR=${1}
	local LAYER="unknown"
	local TARGETS="unknown"
	local CONFIG=${2}
	local IMAGE=core-image-minimal
	local MODE="normal"

	if ! [ -z "$3" ]
	then
		if [ "$3" == "mirror" ] || [ "$3" == "ci" ] || [ "$3" == "normal" ]
		then
			MODE=$3
		fi
	fi

	echo $1 $2 $3 $MODE

	case ${CONFIG} in
	"gui" )
		IMAGE=fsl-image-multimedia-full
		LAYER="meta-tq-distro-fsl"
		export EULA="y"
		;;
	"minimal" )
		IMAGE=core-image-minimal
		LAYER="meta-tq"
		;;
	* )
		usage
		exit 1
		;;
	esac

	# filter out machines from the layer 
	TARGETS=$(ls sources/${LAYER}/conf/machine/*.conf | \
		sed s/\.conf//g | xargs -n1 basename)
	echo "TARGETS=$TARGETS" > ${CONFIG}.prop

	# source the real setup workhorse.
	export MACHINE=$(echo $TARGETS | awk '{ print $1 }')
	. ./setup-environment ${BUILD_DIR} ${CONFIG}
	[ "$?" -ne "0" ] && echo "environment setup failed" && exit 1

	if [ "${MODE}" == "mirror" ]; then
		echo "build mirror"
		echo "INHERIT_remove = \"uninative\"" | tee -a conf/local.conf
		echo "BB_GENERATE_MIRROR_TARBALLS = \"1\"" | tee -a conf/local.conf
		echo "clean local dirs in $(pwd) ..."
		rm -rf cache tmp sstate-cache
		SETTER=$(bitbake -e -c fetchall core-image-minimal | grep ^DL_DIR)
		echo "$SETTER"
		export ${SETTER}
		echo "clean git2 tarballs from ${DL_DIR} ..."
		rm -rf ${DL_DIR}/git2_*.tar.gz
		rm -rf ${DL_DIR}/git2_*.tar.gz.done
		ls -1 ${DL_DIR}/git2_*

		for t in $TARGETS; do
			export MACHINE=$t
			echo "baking: ${MACHINE} ${IMAGE} with -c fetchall"
			bitbake -c fetchall ${IMAGE}
		done
	else
		echo "build images"

		if [ "${MODE}" == "ci" ]; then
			echo "INHERIT_remove = \"uninative\"" | tee -a conf/local.conf
			echo "SOURCE_MIRROR_URL ?= \"file:///mnt/git-tqsc/yocto/\"" | tee -a conf/local.conf
			echo "INHERIT += \"own-mirrors\"" | tee -a conf/local.conf
			echo "BB_FETCH_PREMIRRORONLY = \"1\"" | tee -a conf/local.conf
			echo "BB_NO_NETWORK = \"1\"" | tee -a conf/local.conf
			echo "PREMIRRORS_prepend = \"\\" | tee -a conf/local.conf
			echo "	git://.*/.* file:///mnt/git-tqsc/yocto/ \n \\" | tee -a conf/local.conf
			echo "	ftp://.*/.* file:///mnt/git-tqsc/yocto/ \n \\" | tee -a conf/local.conf
			echo "	http://.*/.* file:///mnt/git-tqsc/yocto/ \n \\" | tee -a conf/local.conf
			echo "	https://.*/.* file:///mnt/git-tqsc/yocto/ \n \\" | tee -a conf/local.conf
			echo "	\"" | tee -a conf/local.conf
		fi

		for t in $TARGETS; do
			export MACHINE=$t
			echo "baking ${MACHINE} ${IMAGE} ..."
			bitbake ${IMAGE}
			[ "$?" -ne "0" ] && echo "bitbake for ${MACHINE} failed" && exit 1
		done
	fi

	return 0
}

main ${@}

