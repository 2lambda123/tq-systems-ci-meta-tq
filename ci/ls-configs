#!/bin/bash
# SPDX-License-Identifier: GPL-2.0-or-later
#
# Copyright (C) 2022-2023 TQ-Systems GmbH <oss@ew.tq-group.com>,
# D-82229 Seefeld, Germany.
# Author: Markus Niebel
#
# Description: list all configs in buildspace
#
###############################################################################

set -e
set -C # noclobber


trap 'error_abort $LINENO' ERR

function error_abort () {
	echo "error at $1"
}

readonly DEFAULT_TEMPLATEDIR="template"
readonly SCRIPT="$(basename "${0}")"

usage() {
	cat <<END
$1 usage:

list available configs from template dir under sources
$1 - use default template dir ${DEFAULT_TEMPLATEDIR}
template needs to have the structure of a layer and templates are
needs to be under <template dir>/conf/templates/.
END
}

main() {
	if [ "${#}" -gt "1" ] ; then
		usage "${SCRIPT}"
		return 1
	fi

	local TEMPLATEDIR="${1:-${DEFAULT_TEMPLATEDIR}}"
	local TEMPLATEPATH="${TEMPLATEDIR}/conf/templates"

	if ! [ -d "./sources/${TEMPLATEPATH}" ]; then
		usage "${SCRIPT}"
		return 1
	fi

	# filter out ci folder from the template dir
	local EXCLUDE="ci"
	local CONFIGURATIONS="$(find ./sources/${TEMPLATEPATH}/* \
		-maxdepth 1 -type d -exec basename {} \;)"
	CONFIGURATIONS=$(echo "${CONFIGURATIONS}" | grep -vxF "${EXCLUDE}")
	for c in ${CONFIGURATIONS}; do
		echo "${c##*.}"
	done

	return 0
}

main "$@"
